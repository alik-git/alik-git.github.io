!function(){function e(e=80){E=[],L=Math.random()*Math.PI*2;const n=.3*Math.cos(L)+.5,t=.3*Math.sin(L)+.5,s=.3*Math.cos(L+Math.PI)+.5,a=.3*Math.sin(L+Math.PI)+.5;for(let o=0;o<e;o++){const l=o<e/2?1:-1,r=1===l?n:s,c=1===l?t:a;E.push({x:r+.22*(Math.random()-.5),y:c+.22*(Math.random()-.5),label:l})}}function n(){v[1]=-Math.sin(L),v[2]=Math.cos(L),v[0]=-(.5*v[1]+.5*v[2])}function t(){F=E.map((e,n)=>n);for(let e=F.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[F[e],F[n]]=[F[n],F[e]]}P=0}function s(e){W.innerHTML+=e+"\n",W.scrollTop=W.scrollHeight}function a(){W.innerHTML=""}function o(){let e=0,n=0,t=0,s=0;for(const a of E){const o=i(a)===a.label;1===a.label?o?e++:n++:o?t++:s++}return{blueCorrect:e,blueMiss:n,redCorrect:t,redMiss:s}}function l(){if(Math.abs(v[2])<1e-9&&Math.abs(v[1])<1e-9)return"undefined";if(Math.abs(v[2])<1e-9){return`vertical line at x = ${(-v[0]/v[1]).toFixed(3)}`}const e=-v[1]/v[2],n=-v[0]/v[2];return`y = ${e.toFixed(3)}x + ${n.toFixed(3)}`}function r(e){return`<span class="${e>=0?"delta-pos":"delta-neg"}">${e>=0?"+":""}${e.toFixed(4)}</span>`}function c(){const e=o(),n=e.blueCorrect+e.blueMiss,t=e.redCorrect+e.redMiss;s('<span class="step-header">Initial State</span>'),s(`<span class="line"><span class="blue">${n} blue points</span> <span class="dim">(class +1)</span> &nbsp; <span class="red">${t} red points</span> <span class="dim">(class -1)</span></span>`),s(`<span class="line"><span class="boundary">Boundary: ${l()}</span></span>`),s(`<span class="line"><span class="weights">Weights: bias=${v[0].toFixed(4)}, w1=${v[1].toFixed(4)}, w2=${v[2].toFixed(4)}</span></span>`),s(`<span class="line"><span class="miss">${e.blueMiss+e.redMiss} misclassified:</span> <span class="blue">${e.blueMiss} blue</span> + <span class="red">${e.redMiss} red</span> on wrong side</span>`)}function i(e){return v[0]+v[1]*e.x+v[2]*e.y>=0?1:-1}function p(){let e=0;for(const n of E)i(n)!==n.label&&e++;return e}function d(){const e=parseInt(document.getElementById("perceptron-batch-slider").value),n=[];for(let e=0;e<E.length;e++)i(E[e])!==E[e].label&&n.push(e);if(0===n.length)return C=0,S=new Set,s('<span class="converged">Converged! All points classified correctly.</span>'),!1;for(let e=n.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[n[e],n[t]]=[n[t],n[e]]}const t=n.slice(0,e);S=new Set(t),B++;let a=0,c=0;for(const e of t)1===E[e].label?a++:c++;const d=[...v];for(const e of t){const n=E[e];v[0]+=T*n.label,v[1]+=T*n.label*n.x,v[2]+=T*n.label*n.y}C=p();const u=o(),f=v[0]-d[0],h=v[1]-d[1],b=v[2]-d[2];return s(`<span class="step-header">Step ${B} &mdash; trained on ${t.length} point${t.length>1?"s":""} <span class="dim">(</span><span class="blue">${a} blue</span><span class="dim">,</span> <span class="red">${c} red</span><span class="dim">)</span></span>`),s(`<span class="line">Weight deltas: bias ${r(f)}, w1 ${r(h)}, w2 ${r(b)}</span>`),s(`<span class="line"><span class="weights">Weights now: bias=${v[0].toFixed(4)}, w1=${v[1].toFixed(4)}, w2=${v[2].toFixed(4)}</span></span>`),s(`<span class="line"><span class="boundary">Boundary: ${l()}</span></span>`),s(`<span class="line"><span class="blue">${u.blueCorrect} blue correct</span>${u.blueMiss>0?`, <span class="miss">${u.blueMiss} blue misclassified</span>`:""} &nbsp;|&nbsp; <span class="red">${u.redCorrect} red correct</span>${u.redMiss>0?`, <span class="miss">${u.redMiss} red misclassified</span>`:""}</span>`),0===C&&s(`<span class="converged">All ${E.length} points classified correctly!</span>`),!0}function u(e,n){const t=60;return[t+e*(I-2*t),x-t-n*(x-2*t)]}function f(){if(Math.abs(v[2])<1e-9&&Math.abs(v[1])<1e-9)return;y.strokeStyle="#ffcc00",y.lineWidth=2,y.setLineDash([8,4]),y.beginPath();const e=[];if(Math.abs(v[2])>1e-9)for(const n of[0,1]){const t=-(v[0]+v[1]*n)/v[2];e.push([n,t])}if(Math.abs(v[1])>1e-9)for(const n of[0,1]){const t=-(v[0]+v[2]*n)/v[1];e.push([t,n])}const n=e.filter(([e,n])=>e>=-.1&&e<=1.1&&n>=-.1&&n<=1.1);if(n.length>=2){const[e,t]=u(n[0][0],n[0][1]),[s,a]=u(n[1][0],n[1][1]);y.moveTo(e,t),y.lineTo(s,a),y.stroke()}y.setLineDash([])}function h(){if(Math.abs(v[1])<1e-9&&Math.abs(v[2])<1e-9)return;const e=60,n=y.getImageData(e,e,I-2*e,x-2*e),t=n.data,s=I-2*e,a=x-2*e;for(let e=0;e<a;e++)for(let n=0;n<s;n++){const o=n/s,l=1-e/a,r=4*(e*s+n);v[0]+v[1]*o+v[2]*l>=0?(t[r]=60,t[r+1]=100,t[r+2]=180,t[r+3]=35):(t[r]=220,t[r+1]=60,t[r+2]=60,t[r+3]=35)}y.putImageData(n,e,e)}function b(){y.clearRect(0,0,I,x),y.strokeStyle="#1a1a3a",y.lineWidth=1;const e=60;for(let n=0;n<=10;n++){const t=e+n*(I-2*e)/10,s=e+n*(x-2*e)/10;y.beginPath(),y.moveTo(t,e),y.lineTo(t,x-e),y.stroke(),y.beginPath(),y.moveTo(e,s),y.lineTo(I-e,s),y.stroke()}h(),f();for(let e=0;e<E.length;e++){const n=E[e],[t,s]=u(n.x,n.y),a=i(n)===n.label;y.beginPath(),y.arc(t,s,5,0,2*Math.PI),1===n.label?(y.fillStyle="#4a9eff",y.fill()):(y.strokeStyle="#ff6b6b",y.lineWidth=2,y.stroke()),a||(y.beginPath(),y.arc(t,s,9,0,2*Math.PI),y.strokeStyle="#ffcc00",y.lineWidth=1.5,y.stroke()),S.has(e)&&(y.beginPath(),y.arc(t,s,12,0,2*Math.PI),y.strokeStyle="#00ff88",y.lineWidth=2,y.stroke())}document.getElementById("perceptron-step-num").textContent=B,document.getElementById("perceptron-errors").textContent=C}function m(){d(),b()}function g(){function e(s){if(w){if(s-n>=t){if(d(),b(),n=s,0===C)return w=!1,void(document.getElementById("perceptron-btn-run").textContent="Run");if(B>5e3)return w=!1,void(document.getElementById("perceptron-btn-run").textContent="Run")}k=requestAnimationFrame(e)}}if(w)return w=!1,void(document.getElementById("perceptron-btn-run").textContent="Run");w=!0,document.getElementById("perceptron-btn-run").textContent="Pause";let n=0;const t=50;k=requestAnimationFrame(e)}function M(){w=!1,document.getElementById("perceptron-btn-run").textContent="Run",cancelAnimationFrame(k),B=0,C=0,S=new Set,e(),n(),t(),C=p(),a(),c(),b()}const $=document.getElementById("perceptron-canvas"),y=$.getContext("2d"),I=$.width,x=$.height;let E=[],v=[0,0,0],B=0,C=0,w=!1,k=null,F=[],P=0,S=new Set;const T=.01;let L=0;const W=document.getElementById("perceptron-log");document.getElementById("perceptron-btn-step").addEventListener("click",m),document.getElementById("perceptron-btn-run").addEventListener("click",g),document.getElementById("perceptron-btn-reset").addEventListener("click",M);const A=document.getElementById("perceptron-batch-slider"),R=document.getElementById("perceptron-batch-label");A.addEventListener("input",()=>{const e=parseInt(A.value);R.textContent=e>=E.length?"All":e}),e(),n(),t(),C=p(),c(),b()}();